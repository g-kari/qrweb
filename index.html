<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    #reader {
      width: 100%;
      max-width: 350px;
      margin: 0 auto 20px auto;
      border: 2px solid #007bff;
      border-radius: 10px;
      overflow: hidden;
    }
    
    #result, #position {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      word-wrap: break-word;
    }
    
    #result {
      font-weight: bold;
      color: #28a745;
    }
    
    #position {
      font-size: 14px;
      color: #6c757d;
      font-family: monospace;
    }
    
    .status {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .error {
      background-color: #f8d7da !important;
      border-color: #f5c6cb !important;
      color: #721c24 !important;
    }
    
    .warning {
      background-color: #fff3cd !important;
      border-color: #ffeaa7 !important;
      color: #856404 !important;
    }
    
    .file-input-area {
      border: 2px dashed #007bff;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
      background-color: #f8f9fa;
    }
    
    #fileInput {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h1>
    <div class="status" id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</div>
    <div id="reader"></div>
    <div id="result" style="display:none;"></div>
    <div id="position" style="display:none;"></div>
    
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
    <div class="file-input-area" id="fileInputArea" style="display:none;">
      <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Š</h3>
      <p>ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ããªã„å ´åˆã¯ã€QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
      <input type="file" id="fileInput" accept="image/*" />
    </div>
  </div>

  <script>
    // QRã‚³ãƒ¼ãƒ‰ã®å›è»¢è§’åº¦ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    // ã‚ˆã‚Šæ­£ç¢ºãªè§’åº¦è¨ˆç®—ã®ãŸã‚ã€4ã¤ã®è§’ç‚¹å…¨ã¦ã‚’ä½¿ç”¨ã—ã¦æœ€é©ãªè¾ºã‚’ç‰¹å®š
    function calculateQRRotation(points) {
      if (points.length < 2) {
        return null;
      }
      
      if (points.length >= 4) {
        // QRã‚³ãƒ¼ãƒ‰ã®4è§’ç‚¹ã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªè¾ºã‚’é¸ã‚“ã§å‚¾ãã‚’è¨ˆç®—
        // é€šå¸¸ã€QRã‚³ãƒ¼ãƒ‰ã®æ¤œå‡ºç‚¹ã¯æ™‚è¨ˆå›ã‚Šé †åºã§é…ç½®ã•ã‚Œã¦ã„ã‚‹
        const angles = [];
        
        // å„è¾ºã®è§’åº¦ã‚’è¨ˆç®—
        for (let i = 0; i < points.length; i++) {
          const p1 = points[i];
          const p2 = points[(i + 1) % points.length];
          const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI);
          angles.push(angle);
        }
        
        // æœ€ã‚‚æ°´å¹³ã«è¿‘ã„è¾ºã‚’åŸºæº–ã¨ã—ã¦ä½¿ç”¨ï¼ˆQRã‚³ãƒ¼ãƒ‰ã®ä¸Šè¾ºã¾ãŸã¯ä¸‹è¾ºï¼‰
        let bestAngle = angles[0];
        let minAngleDiff = Math.abs(angles[0] % 90);
        
        for (let i = 1; i < angles.length; i++) {
          const angleDiff = Math.abs(angles[i] % 90);
          if (angleDiff < minAngleDiff) {
            minAngleDiff = angleDiff;
            bestAngle = angles[i];
          }
        }
        
        // è§’åº¦ã‚’-90ã€œ90åº¦ã®ç¯„å›²ã«æ­£è¦åŒ–
        let rotationAngle = bestAngle;
        while (rotationAngle > 90) rotationAngle -= 180;
        while (rotationAngle < -90) rotationAngle += 180;
        
        return rotationAngle;
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: 2ç‚¹ä»¥ä¸Šã‚ã‚Œã°åŸºæœ¬çš„ãªè¨ˆç®—ã‚’å®Ÿè¡Œ
        const deltaX = points[1].x - points[0].x;
        const deltaY = points[1].y - points[0].y;
        return Math.atan2(deltaY, deltaX) * (180 / Math.PI);
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
      document.getElementById('result').style.display = 'block';
      document.getElementById('position').style.display = 'block';
      document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼';
      
      // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’è¡¨ç¤º
      document.getElementById('result').innerText = `ã‚¹ã‚­ãƒ£ãƒ³çµæœ: ${decodedText}`;
      
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      console.log('Decoded result full object:', decodedResult);
      if (decodedResult && decodedResult.result) {
        console.log('Result points:', decodedResult.result.resultPoint);
        console.log('Result metadata:', decodedResult.result.resultMetadata);
      }
      
      // QRã‚³ãƒ¼ãƒ‰ã®ä½ç½®æƒ…å ±ã‚’è¡¨ç¤º
      const positionDiv = document.getElementById('position');
      if (decodedResult && decodedResult.result && decodedResult.result.resultPoint) {
        const points = decodedResult.result.resultPoint;
        let positionText = 'QRã‚³ãƒ¼ãƒ‰ã®ä½ç½®æƒ…å ±:\n';
        
        // å„è§’ç‚¹ã®åº§æ¨™ã‚’è¡¨ç¤º
        points.forEach((point, index) => {
          positionText += `è§’${index + 1}: x=${Math.round(point.x)}, y=${Math.round(point.y)}\n`;
        });
        
        // QRã‚³ãƒ¼ãƒ‰ã®ä¸­å¿ƒç‚¹ã‚’è¨ˆç®—
        const centerX = points.reduce((sum, point) => sum + point.x, 0) / points.length;
        const centerY = points.reduce((sum, point) => sum + point.y, 0) / points.length;
        positionText += `ä¸­å¿ƒç‚¹: x=${Math.round(centerX)}, y=${Math.round(centerY)}\n`;
        
        // QRã‚³ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºï¼ˆå¹…ã¨é«˜ã•ï¼‰ã‚’è¨ˆç®—
        if (points.length >= 4) {
          const minX = Math.min(...points.map(p => p.x));
          const maxX = Math.max(...points.map(p => p.x));
          const minY = Math.min(...points.map(p => p.y));
          const maxY = Math.max(...points.map(p => p.y));
          const width = maxX - minX;
          const height = maxY - minY;
          positionText += `ã‚µã‚¤ã‚º: å¹…=${Math.round(width)}px, é«˜ã•=${Math.round(height)}px\n`;
        }
        
        // QRã‚³ãƒ¼ãƒ‰ã®å‚¾ãï¼ˆå›è»¢è§’åº¦ï¼‰ã‚’è¨ˆç®—
        const rotationAngle = calculateQRRotation(points);
        if (rotationAngle !== null) {
          positionText += `å‚¾ã: ${Math.round(rotationAngle * 100) / 100}Â°`;
        }
        
        positionDiv.innerHTML = positionText.replace(/\n/g, '<br>');
      } else {
        // ä½ç½®æƒ…å ±ãŒå–å¾—ã§ããªã„å ´åˆã®è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±
        console.log('Position data not available. Decoded result structure:', decodedResult);
        let errorMsg = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
        
        if (!decodedResult) {
          errorMsg += '<br>ç†ç”±: decodedResult ãŒ null ã¾ãŸã¯ undefined ã§ã™';
        } else if (!decodedResult.result) {
          errorMsg += '<br>ç†ç”±: decodedResult.result ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
        } else if (!decodedResult.result.resultPoint) {
          errorMsg += '<br>ç†ç”±: resultPoint ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
        } else if (decodedResult.result.resultPoint.length === 0) {
          errorMsg += '<br>ç†ç”±: resultPoint ãŒç©ºã®é…åˆ—ã§ã™';
        }
        
        positionDiv.innerHTML = errorMsg;
      }
    }

    function onScanFailure(error) {
      // ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã—ãªã„ï¼ˆé€£ç¶šçš„ã«ã‚¹ã‚­ãƒ£ãƒ³ã‚’è©¦è¡Œã™ã‚‹ãŸã‚ï¼‰
    }

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" }, // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨
      {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
      },
      onScanSuccess,
      onScanFailure
    ).then(() => {
      document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„';
    }).catch((err) => {
      console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
      const statusElement = document.getElementById('status');
      
      if (err.toString().includes('NotAllowedError') || err.toString().includes('Permission')) {
        statusElement.textContent = 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        statusElement.className = 'status warning';
      } else if (err.toString().includes('NotSupportedError') || err.toString().includes('not supported')) {
        statusElement.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯ç’°å¢ƒã§ã¯ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚HTTPSæ¥ç¶šã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
        statusElement.className = 'status error';
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¡¨ç¤º
        document.getElementById('fileInputArea').style.display = 'block';
        setupFileUpload();
      } else {
        statusElement.textContent = `ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${err}`;
        statusElement.className = 'status error';
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¡¨ç¤º
        document.getElementById('fileInputArea').style.display = 'block';
        setupFileUpload();
      }
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupFileUpload() {
      const fileInput = document.getElementById('fileInput');
      if (fileInput && !fileInput.hasEventListener) {
        fileInput.hasEventListener = true;
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.scanFile(file, true)
              .then(decodedText => {
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã‚‚ä½ç½®æƒ…å ±ã®å–å¾—ã‚’è©¦è¡Œ
                document.getElementById('result').style.display = 'block';
                document.getElementById('position').style.display = 'block';
                document.getElementById('status').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼';
                document.getElementById('result').innerText = `ã‚¹ã‚­ãƒ£ãƒ³çµæœ: ${decodedText}`;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚‚ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ç¢ºèª
                const positionDiv = document.getElementById('position');
                positionDiv.innerHTML = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®èª­ã¿å–ã‚Šã§ã¯è©³ç´°ãªä½ç½®æƒ…å ±ã¯å–å¾—ã§ãã¾ã›ã‚“<br>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚­ãƒ£ãƒ³ã‚’ãŠè©¦ã—ãã ã•ã„';
              })
              .catch(err => {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚';
                document.getElementById('status').className = 'status error';
              });
          }
        });
      }
    }
  </script>
</body>
</html>

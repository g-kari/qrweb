<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    /* Reader container position relative for stamp overlay */
    #reader {
      position: relative;
      width: 100%;
      max-width: 350px;
      margin: 0 auto 20px auto;
      border: 2px solid #007bff;
      border-radius: 10px;
      overflow: hidden;
    }

    #result, #position {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      word-wrap: break-word;
    }
    
    #result {
      font-weight: bold;
      color: #28a745;
    }
    
    #position {
      font-size: 14px;
      color: #6c757d;
      font-family: monospace;
      line-height: 1.6;
    }
    
    #position pre {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 3px;
      padding: 8px;
      margin: 8px 0;
      font-size: 12px;
      overflow-x: auto;
    }
    
    #reader video {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }
    
    .status {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .error {
      background-color: #f8d7da !important;
      border-color: #f5c6cb !important;
      color: #721c24 !important;
    }
    
    .warning {
      background-color: #fff3cd !important;
      border-color: #ffeaa7 !important;
      color: #856404 !important;
    }
    
    .file-input-area {
      border: 2px dashed #007bff;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
      background-color: #f8f9fa;
    }
    
    #fileInput {
      margin: 10px 0;
    }
    
    /* Stamp Animation Styles */
    #stampOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    
    .stamp {
      position: absolute;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, #ff4444, #cc0000);
      border: 4px solid #990000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform: scale(0) rotate(0deg);
      opacity: 0;
    }
    
    .stamp.animate {
      animation: stampPress 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.35) forwards;
    }
    
    @keyframes stampPress {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.2) rotate(5deg);
        opacity: 1;
      }
      70% {
        transform: scale(0.9) rotate(-2deg);
        opacity: 1;
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 0.8;
      }
    }
    
    /* Stamp Rally Navigation */
    .nav-tabs {
      display: flex;
      background-color: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .nav-tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      background-color: #e9ecef;
      color: #6c757d;
      cursor: pointer;
      border: none;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .nav-tab.active {
      background-color: #007bff;
      color: white;
    }
    
    .nav-tab:hover:not(.active) {
      background-color: #dee2e6;
    }
    
    /* Views */
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
    
    /* Collection View */
    .collection-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .collection-progress {
      background-color: #e9ecef;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .progress-bar {
      background-color: #e9ecef;
      border-radius: 8px;
      height: 20px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      border-radius: 8px;
      transition: width 0.5s ease;
    }
    
    .stamps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      padding: 20px 0;
    }
    
    .collected-stamp {
      background: radial-gradient(circle, #28a745, #20c997);
      border: 3px solid #1e7e34;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      margin: 0 auto;
      position: relative;
    }
    
    .stamp-info {
      text-align: center;
      margin-top: 8px;
      font-size: 12px;
      color: #6c757d;
    }
    
    .empty-collection {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }
    
    .empty-collection .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h1>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('scanner')">ğŸ” ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</button>
      <button class="nav-tab" onclick="switchTab('collection')">ğŸ† ã‚¹ã‚¿ãƒ³ãƒ—å¸³</button>
    </div>
    
    <!-- Scanner View -->
    <div id="scannerView" class="view active">
      <div class="status" id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</div>
      <div id="reader">
        <div id="stampOverlay"></div>
      </div>
      <div id="result" style="display:none;"></div>
      <div id="position" style="display:none;"></div>
      
      <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
      <div class="file-input-area" id="fileInputArea" style="display:none;">
        <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Š</h3>
        <p>ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ããªã„å ´åˆã¯ã€QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
        <input type="file" id="fileInput" accept="image/*" />
      </div>
    </div>
    
    <!-- Collection View -->
    <div id="collectionView" class="view">
      <div class="collection-header">
        <h2>ğŸ† ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
      </div>
      
      <div class="collection-progress">
        <div class="progress-info">
          <strong id="progressText">0 / 0 ã‚¹ã‚¿ãƒ³ãƒ—åé›†</strong>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div id="progressMessage">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚ˆã†ï¼</div>
      </div>
      
      <div id="stampsContainer">
        <div class="empty-collection" id="emptyCollection">
          <div class="icon">ğŸ“‹</div>
          <p>ã¾ã ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚Šã¾ã›ã‚“<br>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã¾ã—ã‚‡ã†ï¼</p>
        </div>
        <div class="stamps-grid" id="stampsGrid" style="display: none;"></div>
      </div>
    </div>
  </div>

  <script>
    let video;
    let canvas;
    let canvasContext;
    let animationId;

    // Stamp Rally System
    const StampRally = {
      // Get collected stamps from localStorage
      getCollectedStamps() {
        const stamps = localStorage.getItem('qr-stamps');
        return stamps ? JSON.parse(stamps) : [];
      },
      
      // Save collected stamps to localStorage
      saveCollectedStamps(stamps) {
        localStorage.setItem('qr-stamps', JSON.stringify(stamps));
      },
      
      // Generate unique stamp ID from QR content
      generateStampId(qrContent) {
        // Simple hash function for generating unique IDs
        let hash = 0;
        for (let i = 0; i < qrContent.length; i++) {
          const char = qrContent.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }
        return Math.abs(hash).toString(36);
      },
      
      // Get stamp emoji based on QR content
      getStampEmoji(qrContent) {
        const emojis = ['ğŸŒŸ', 'ğŸ‰', 'ğŸŠ', 'ğŸ†', 'â­', 'ğŸ’', 'ğŸˆ', 'ğŸ', 'ğŸŒˆ', 'ğŸ”¥', 'âœ¨', 'ğŸ¯', 'ğŸª', 'ğŸ­', 'ğŸ¨'];
        const hash = this.generateStampId(qrContent);
        const index = parseInt(hash, 36) % emojis.length;
        return emojis[index];
      },
      
      // Add new stamp to collection
      addStamp(qrContent, positionInfo = null) {
        const stamps = this.getCollectedStamps();
        const stampId = this.generateStampId(qrContent);
        
        // Check if stamp already exists
        const existingStamp = stamps.find(stamp => stamp.id === stampId);
        if (existingStamp) {
          existingStamp.scanCount = (existingStamp.scanCount || 1) + 1;
          existingStamp.lastScanned = new Date().toISOString();
        } else {
          const newStamp = {
            id: stampId,
            content: qrContent,
            emoji: this.getStampEmoji(qrContent),
            collectedAt: new Date().toISOString(),
            lastScanned: new Date().toISOString(),
            scanCount: 1,
            position: positionInfo
          };
          stamps.push(newStamp);
        }
        
        this.saveCollectedStamps(stamps);
        this.updateCollectionDisplay();
        return !existingStamp; // Return true if it's a new stamp
      },
      
      // Update collection display
      updateCollectionDisplay() {
        const stamps = this.getCollectedStamps();
        const totalStamps = stamps.length;
        
        // Update progress
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const progressMessage = document.getElementById('progressMessage');
        
        if (progressText) {
          progressText.textContent = `${totalStamps} ã‚¹ã‚¿ãƒ³ãƒ—åé›†`;
        }
        
        if (progressFill) {
          // For progress bar, we'll show completion as stamps collected
          const progressPercentage = totalStamps > 0 ? Math.min(100, (totalStamps / 10) * 100) : 0;
          progressFill.style.width = `${progressPercentage}%`;
        }
        
        if (progressMessage) {
          if (totalStamps === 0) {
            progressMessage.textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚ˆã†ï¼';
          } else if (totalStamps < 5) {
            progressMessage.textContent = 'ã„ã„ãƒšãƒ¼ã‚¹ã§ã™ï¼ã‚‚ã£ã¨ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã¾ã—ã‚‡ã†ï¼';
          } else if (totalStamps < 10) {
            progressMessage.textContent = 'ã™ã”ã„ï¼ãŸãã•ã‚“ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã¦ã„ã¾ã™ï¼';
          } else {
            progressMessage.textContent = 'ğŸ‰ ã‚¹ã‚¿ãƒ³ãƒ—ãƒã‚¹ã‚¿ãƒ¼ï¼ç´ æ™´ã‚‰ã—ã„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ï¼';
          }
        }
        
        // Update stamps grid
        const emptyCollection = document.getElementById('emptyCollection');
        const stampsGrid = document.getElementById('stampsGrid');
        
        if (totalStamps === 0) {
          if (emptyCollection) emptyCollection.style.display = 'block';
          if (stampsGrid) stampsGrid.style.display = 'none';
        } else {
          if (emptyCollection) emptyCollection.style.display = 'none';
          if (stampsGrid) {
            stampsGrid.style.display = 'grid';
            stampsGrid.innerHTML = '';
            
            stamps.forEach(stamp => {
              const stampElement = document.createElement('div');
              stampElement.innerHTML = `
                <div class="collected-stamp">
                  ${stamp.emoji}
                </div>
                <div class="stamp-info">
                  <div>ID: ${stamp.id}</div>
                  <div>ã‚¹ã‚­ãƒ£ãƒ³å›æ•°: ${stamp.scanCount}</div>
                  <div>${new Date(stamp.collectedAt).toLocaleDateString('ja-JP')}</div>
                </div>
              `;
              stampsGrid.appendChild(stampElement);
            });
          }
        }
      }
    };

    // Tab switching functionality
    function switchTab(tabName) {
      // Update tab buttons
      const tabs = document.querySelectorAll('.nav-tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update views
      const views = document.querySelectorAll('.view');
      views.forEach(view => view.classList.remove('active'));
      
      if (tabName === 'scanner') {
        document.getElementById('scannerView').classList.add('active');
      } else if (tabName === 'collection') {
        document.getElementById('collectionView').classList.add('active');
        StampRally.updateCollectionDisplay();
      }
    }

    // QRä½ç½®æƒ…å ±ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    function calculateQRPosition(location) {
      const corners = [
        location.topLeftCorner,
        location.topRightCorner,
        location.bottomRightCorner,
        location.bottomLeftCorner
      ];

      // ä¸­å¿ƒç‚¹ã‚’è¨ˆç®—
      const centerX = corners.reduce((sum, corner) => sum + corner.x, 0) / 4;
      const centerY = corners.reduce((sum, corner) => sum + corner.y, 0) / 4;

      // QRã‚³ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ï¼ˆå¯¾è§’ç·šã®å¹³å‡ï¼‰
      const width = Math.sqrt(
        Math.pow(location.topRightCorner.x - location.topLeftCorner.x, 2) + 
        Math.pow(location.topRightCorner.y - location.topLeftCorner.y, 2)
      );
      const height = Math.sqrt(
        Math.pow(location.bottomLeftCorner.x - location.topLeftCorner.x, 2) + 
        Math.pow(location.bottomLeftCorner.y - location.topLeftCorner.y, 2)
      );

      // å›è»¢è§’åº¦ã‚’è¨ˆç®—ï¼ˆä¸Šè¾ºã‚’åŸºæº–ï¼‰
      const deltaX = location.topRightCorner.x - location.topLeftCorner.x;
      const deltaY = location.topRightCorner.y - location.topLeftCorner.y;
      const rotationRadians = Math.atan2(deltaY, deltaX);
      const rotationDegrees = rotationRadians * (180 / Math.PI);

      return {
        center: { x: Math.round(centerX), y: Math.round(centerY) },
        corners: corners,
        size: { width: Math.round(width), height: Math.round(height) },
        rotation: Math.round(rotationDegrees * 100) / 100 // å°æ•°ç‚¹2ä½ã¾ã§
      };
    }

    // QRæ¤œå‡ºçµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayQRResult(decodedText, positionInfo) {
      // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
      document.getElementById('result').style.display = 'block';
      document.getElementById('position').style.display = 'block';
      document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼';
      
      // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’è¡¨ç¤º
      document.getElementById('result').innerText = `ã‚¹ã‚­ãƒ£ãƒ³çµæœ: ${decodedText}`;
      
      // ä½ç½®æƒ…å ±ã‚’è¡¨ç¤º
      const positionDiv = document.getElementById('position');
      const cornersText = positionInfo.corners.map((corner, index) => 
        `  è§’${index + 1}: (${corner.x}, ${corner.y})`
      ).join('\n');
      
      positionDiv.innerHTML = `
        <strong>ğŸ¯ QRã‚³ãƒ¼ãƒ‰ä½ç½®æƒ…å ±</strong><br>
        <strong>ä¸­å¿ƒåº§æ¨™:</strong> (${positionInfo.center.x}, ${positionInfo.center.y})<br>
        <strong>ã‚µã‚¤ã‚º:</strong> ${positionInfo.size.width} Ã— ${positionInfo.size.height} px<br>
        <strong>å›è»¢è§’åº¦:</strong> ${positionInfo.rotation}Â°<br>
        <strong>4ã¤ã®è§’ã®åº§æ¨™:</strong><br>
        <pre>${cornersText}</pre>
      `;

      // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
      const isNewStamp = StampRally.addStamp(decodedText, positionInfo);
      
      // ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
      showStampAnimation(positionInfo, isNewStamp);

      console.log('QR Position Info:', positionInfo);
    }

    // ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showStampAnimation(positionInfo, isNewStamp = true) {
      const stampOverlay = document.getElementById('stampOverlay');
      const readerElement = document.getElementById('reader');
      
      // æ—¢å­˜ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
      stampOverlay.innerHTML = '';
      
      // readerè¦ç´ ã®ã‚µã‚¤ã‚ºã¨ä½ç½®ã‚’å–å¾—
      const readerRect = readerElement.getBoundingClientRect();
      const video = readerElement.querySelector('video');
      
      if (video && video.videoWidth > 0 && video.videoHeight > 0) {
        const videoRect = video.getBoundingClientRect();
        
        // ãƒ“ãƒ‡ã‚ªå†…ã§ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—
        const scaleX = videoRect.width / video.videoWidth;
        const scaleY = videoRect.height / video.videoHeight;
        
        // QRã‚³ãƒ¼ãƒ‰ã®ä¸­å¿ƒä½ç½®ã‚’ãƒ“ãƒ‡ã‚ªè¡¨ç¤ºã‚µã‚¤ã‚ºã«ã‚¹ã‚±ãƒ¼ãƒ«
        const stampX = positionInfo.center.x * scaleX;
        const stampY = positionInfo.center.y * scaleY;
        
        // ã‚¹ã‚¿ãƒ³ãƒ—è¦ç´ ã‚’ä½œæˆ
        const stamp = document.createElement('div');
        stamp.className = 'stamp';
        
        // æ–°ã—ã„ã‚¹ã‚¿ãƒ³ãƒ—ã‹æ—¢å­˜ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã§è¡¨ç¤ºã‚’å¤‰æ›´
        if (isNewStamp) {
          stamp.innerHTML = 'ğŸ†•';
          stamp.style.background = 'radial-gradient(circle, #28a745, #20c997)';
          stamp.style.borderColor = '#1e7e34';
        } else {
          stamp.innerHTML = 'âœ“';
          stamp.style.background = 'radial-gradient(circle, #ffc107, #e0a800)';
          stamp.style.borderColor = '#d39e00';
        }
        
        // ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
        stamp.style.left = `${stampX - 40}px`; // ã‚¹ã‚¿ãƒ³ãƒ—ã®åŠåˆ†ã®ã‚µã‚¤ã‚ºã‚’å¼•ã
        stamp.style.top = `${stampY - 40}px`;
        stamp.style.transform = `scale(0) rotate(${positionInfo.rotation}deg)`;
        
        // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«è¿½åŠ 
        stampOverlay.appendChild(stamp);
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        setTimeout(() => {
          stamp.classList.add('animate');
        }, 100);
        
        // 3ç§’å¾Œã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
        setTimeout(() => {
          if (stamp.parentNode) {
            stamp.remove();
          }
        }, 3000);
      } else {
        // ãƒ“ãƒ‡ã‚ªãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç°¡æ˜“ç‰ˆã‚’ä½¿ç”¨
        showSimpleStampAnimation(isNewStamp);
      }
    }

    // ç°¡æ˜“ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä½ç½®æƒ…å ±ãªã—ã®å ´åˆï¼‰
    function showSimpleStampAnimation(isNewStamp = true) {
      const stampOverlay = document.getElementById('stampOverlay');
      const readerElement = document.getElementById('reader');
      
      // æ—¢å­˜ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
      stampOverlay.innerHTML = '';
      
      // readerè¦ç´ ã®ä¸­å¤®ã«é…ç½®
      const readerRect = readerElement.getBoundingClientRect();
      const centerX = readerElement.offsetWidth / 2;
      const centerY = readerElement.offsetHeight / 2;
      
      // ã‚¹ã‚¿ãƒ³ãƒ—è¦ç´ ã‚’ä½œæˆ
      const stamp = document.createElement('div');
      stamp.className = 'stamp';
      
      // æ–°ã—ã„ã‚¹ã‚¿ãƒ³ãƒ—ã‹æ—¢å­˜ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã§è¡¨ç¤ºã‚’å¤‰æ›´
      if (isNewStamp) {
        stamp.innerHTML = 'ğŸ†•';
        stamp.style.background = 'radial-gradient(circle, #28a745, #20c997)';
        stamp.style.borderColor = '#1e7e34';
      } else {
        stamp.innerHTML = 'âœ“';
        stamp.style.background = 'radial-gradient(circle, #ffc107, #e0a800)';
        stamp.style.borderColor = '#d39e00';
      }
      
      // ä¸­å¤®ã«ä½ç½®ã‚’è¨­å®š
      stamp.style.left = `${centerX - 40}px`;
      stamp.style.top = `${centerY - 40}px`;
      stamp.style.transform = 'scale(0) rotate(0deg)';
      
      // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«è¿½åŠ 
      stampOverlay.appendChild(stamp);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      setTimeout(() => {
        stamp.classList.add('animate');
      }, 100);
      
      // 3ç§’å¾Œã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
      setTimeout(() => {
        if (stamp.parentNode) {
          stamp.remove();
        }
      }, 3000);
    }

    // ã‚«ãƒ¡ãƒ©ã¨jsQRã‚’ä½¿ç”¨ã—ãŸQRæ¤œå‡º
    function initCamera() {
      console.log('Initializing camera...');
      video = document.createElement('video');
      canvas = document.createElement('canvas');
      canvasContext = canvas.getContext('2d');

      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      })
      .then(function(stream) {
        console.log('Camera access granted');
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();
        
        // videoè¦ç´ ã‚’readerã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
        const readerDiv = document.getElementById('reader');
        readerDiv.innerHTML = '';
        readerDiv.appendChild(video);
        
        document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„';
        requestAnimationFrame(tick);
      })
      .catch(function(err) {
        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
        // html5-qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        fallbackToHtml5QrCode(err);
      });
    }

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
        
        try {
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });

          if (code && code.location) {
            console.log('QR code detected:', code.data);
            const positionInfo = calculateQRPosition(code.location);
            displayQRResult(code.data, positionInfo);
            
            // æ¤œå‡ºå¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†é–‹ï¼ˆé€£ç¶šæ¤œå‡ºã‚’é˜²ãï¼‰
            setTimeout(() => {
              animationId = requestAnimationFrame(tick);
            }, 2000);
          } else {
            animationId = requestAnimationFrame(tick);
          }
        } catch (error) {
          console.error('QR scanning error:', error);
          animationId = requestAnimationFrame(tick);
        }
      } else {
        animationId = requestAnimationFrame(tick);
      }
    }

    // html5-qrcodeã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    function fallbackToHtml5QrCode(error) {
      const statusElement = document.getElementById('status');
      
      if (error.toString().includes('NotAllowedError') || error.toString().includes('Permission')) {
        statusElement.textContent = 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        statusElement.className = 'status warning';
        setupFileUpload();
        return;
      }

      console.log('jsQRã§ã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã€html5-qrcodeã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
      
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        },
        function(decodedText, decodedResult) {
          document.getElementById('result').style.display = 'block';
          document.getElementById('position').style.display = 'block';
          document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼';
          document.getElementById('result').innerText = `ã‚¹ã‚­ãƒ£ãƒ³çµæœ: ${decodedText}`;
          
          const positionDiv = document.getElementById('position');
          positionDiv.innerHTML = '<strong>âš ï¸ ä½ç½®æƒ…å ±åˆ¶é™</strong><br>html5-qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯è©³ç´°ãªä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚<br>åŸºæœ¬çš„ãªQRã‚³ãƒ¼ãƒ‰å†…å®¹ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
          
          // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
          const isNewStamp = StampRally.addStamp(decodedText, null);
          
          // ç°¡æ˜“ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸­å¤®ã«è¡¨ç¤ºï¼‰
          showSimpleStampAnimation(isNewStamp);
          
          console.log('Decoded result (html5-qrcode):', decodedResult);
        },
        function(error) {
          // ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã—ãªã„ï¼ˆé€£ç¶šçš„ã«ã‚¹ã‚­ãƒ£ãƒ³ã‚’è©¦è¡Œã™ã‚‹ãŸã‚ï¼‰
        }
      ).then(() => {
        document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰';
      }).catch((err) => {
        console.error('html5-qrcodeã‚¨ãƒ©ãƒ¼:', err);
        statusElement.textContent = 'ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
        statusElement.className = 'status error';
        setupFileUpload();
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupFileUpload() {
      document.getElementById('fileInputArea').style.display = 'block';
      
      const fileInput = document.getElementById('fileInput');
      if (fileInput && !fileInput.hasEventListener) {
        fileInput.hasEventListener = true;
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            processImageFile(file);
          }
        });
      }
    }

    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º
    function processImageFile(file) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
          const positionInfo = calculateQRPosition(code.location);
          displayQRResult(code.data, positionInfo);
        } else {
          // jsQRã§å¤±æ•—ã—ãŸå ´åˆã€html5-qrcodeã§ãƒªãƒˆãƒ©ã‚¤
          const html5QrCode = new Html5Qrcode("reader");
          html5QrCode.scanFile(file, true)
            .then(decodedText => {
              document.getElementById('result').style.display = 'block';
              document.getElementById('position').style.display = 'block';
              document.getElementById('status').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼';
              document.getElementById('result').innerText = `ã‚¹ã‚­ãƒ£ãƒ³çµæœ: ${decodedText}`;
              
              const positionDiv = document.getElementById('position');
              positionDiv.innerHTML = '<strong>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³</strong><br>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®èª­ã¿å–ã‚Šã§ã¯è©³ç´°ãªä½ç½®æƒ…å ±ã¯å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚­ãƒ£ãƒ³ã§è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚';
              
              // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
              const isNewStamp = StampRally.addStamp(decodedText, null);
              
              // ç°¡æ˜“ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
              showSimpleStampAnimation(isNewStamp);
            })
            .catch(err => {
              console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', err);
              document.getElementById('status').textContent = 'QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚';
              document.getElementById('status').className = 'status error';
            });
        }
        URL.revokeObjectURL(img.src); // Release the object URL to free up memory
      };
      
      img.src = URL.createObjectURL(file);
    }

    // åˆæœŸåŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initCamera();
        // Initialize stamp rally display
        StampRally.updateCollectionDisplay();
      });
    } else {
      initCamera();
      // Initialize stamp rally display
      StampRally.updateCollectionDisplay();
    }
  </script>
</body>
</html>
